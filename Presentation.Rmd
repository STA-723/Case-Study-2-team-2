---
title: "NYC AirBNB Data"
author: Shrey Gupta, Joseph Lawson, Joseph Mathews
output: 
  beamer_presentation
---

```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(tidyverse)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(rgeos)
library(gridExtra)
library(ggridges)

data <- read_csv("AB_NYC_2019.csv")
data <- data %>% filter(number_of_reviews > 0, availability_365 > 0,price>0)
data <- data %>% mutate(reviews_per_stay = (reviews_per_month * minimum_nights )/availability_365)



```

# Introduction/EDA

 - New York City *Airbnb* data from 2019.
    - Variables include listing locations (neighbourhoods and NYC boroughs), price, and reviews per month.
    - Goal: Discover which variables contribute to price and popularity.

 



# Distribution of Price
```{r,echo=FALSE,fig.align='left',fig.height=3,fig.width=4,warning=FALSE,message=FALSE,fig.cap="Log of Price"}
data %>% filter(price < 600) %>%
  ggplot(aes(x=log(price),y=neighbourhood_group)) + geom_density_ridges() + ylab(" ") + xlab("")
```


# Distribution of Price
```{r,echo=FALSE}
world <- ne_countries(scale = "medium", returnclass = "sf")
sites <- data %>% filter(price< 1000) %>% select(latitude,longitude,price)
names <- c("Brooklyn", "Manhattan", "Queens", "Staten Island","Bronx")
lat <- c(40.673611,40.779746,40.7282,40.5795,40.8448)
lon <- c(-73.944313,-73.970658,-73.7949,-74.1502,-73.8648)
points <- tibble(names,lat,lon)
longitude.min <- min(sites$longitude); longitude.max <- max(sites$longitude)
latitude.min <- min(sites$latitude); latitude.max <-  max(sites$latitude)
```


```{r,echo=FALSE,fig.align='center',fig.height=3.25,fig.width=5.25,warning=FALSE,fig.cap="Distribution of Price"}
sites <- data %>% filter(price < 600, reviews_per_stay > 0)  %>% select(latitude,longitude,price)
ggplot(data = world) +
  geom_sf() +
  geom_point(data = sites, aes(x = longitude, y = latitude,col=price), size = 0.0005, shape = 20,show.legend = FALSE) +
  geom_text(aes(x=lon,y=lat,label=names),data=points) + xlim(c(longitude.min,longitude.max))  +
  ylim(c(latitude.min, latitude.max)) + 
  guides(col= FALSE)  +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        )
```



# Distribution of Room Type

```{r,echo=FALSE,fig.align='center',fig.height=3.25,fig.width=4.75,fig.cap="Distribution of Room Type Weighted by Price"}
sites <- data %>% filter(price < 600)  %>% select(latitude,longitude,room_type,price)
ggplot(data = world) +
  geom_sf() +
  geom_point(data = sites, aes(x = longitude, y = latitude,col=room_type,alpha=price), size = 0.001, shape = 20) +
  geom_text(aes(x=lon,y=lat,label=names),data=points) + 
  xlim(c(longitude.min,longitude.max)) + ylim(c(latitude.min, latitude.max)) +
  guides(alpha= FALSE) +
  scale_color_discrete(name="Room Type") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.text = element_text(size=4),
        legend.title = element_text(size=4),
        legend.background = element_rect(size=4)
        )
                      
```


# Distribution of Reviews per Stay 

```{r,echo=FALSE,fig.align='left',fig.height=3,fig.width=4,warning=FALSE,message=FALSE,fig.cap="Log of Reviews Per Stay"}
data %>% filter(reviews_per_stay < 0.5) %>%
  ggplot(aes(x=log(reviews_per_stay),y=neighbourhood_group)) + geom_density_ridges() + ylab(" ") + xlab("")
```



# Distribution of Reviews per Stay

```{r,echo=FALSE,fig.align='center',fig.height=3.25,fig.width=5.25,warning=FALSE,fig.cap="Distribution of Price Weighted by Reviews per Stay"}
sites <- data  %>% filter(reviews_per_stay > 0, price < 600) %>% select(latitude,longitude,reviews_per_stay,price)
ggplot(data = world) +
  geom_sf() +
  geom_point(data = sites, aes(x = longitude, y = latitude,col=price,alpha=reviews_per_stay), size = 0.0005, shape = 20,show.legend = FALSE) +
  geom_text(aes(x=lon,y=lat,label=names),data=points)+ xlim(c(longitude.min,longitude.max))  +
  ylim(c(latitude.min, latitude.max)) + 
  guides(alpha= FALSE) +
  scale_color_continuous(name="Room Type") +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        legend.text = element_text(size=4),
        legend.title = element_text(size=4),
        legend.background = element_rect(size=4)
        )
```

# Analysis

- Drop Zero Review/Zero Days Available
- Cap Price at 600/Cap Minimum Stay at 30
- Removed all observations in which $\text{number of reviews } = 0$, $\text{availability 365 } = 0$, or $\text{price} = 0$. . 
- Defined a popularity metric as: $\text{reviews per stay = }\frac{(\text{reviews per month})}{(\text{minimum nights})/(\text{availability 365})}$
  - $(\text{minimum nights})/(\text{availability 365}) \approx \text{number of possible bookings}$
  - Serves as a "corrected" version of reviews per month.


# CAR Model

Specify CAR structure for $\phi$:
$$
  \phi_i|\phi_{-i},\tau_i^2\sim N\bigg(\rho\sum b_{ij}\phi_j,\tau_i^2\bigg)
$$
- Set $b_{ij} = w_{ij} / w_{i+}$ ($w_{i+}$ is $i's$ neighbor count)

- Set $\tau_i^2 = \frac{\sigma^2}{w_{i+}}$

Then we have joint distribution:

$$
\phi|W,\sigma^2\sim N\big(0,\sigma^2(D-\rho W)^{-1}\big)
$$
- W is adjacency matrix of neighborhoods

- D is diagonal with $d_{ii}$ the count of $i's$ neighbors

- $\rho\in(0,1)$ calibrates strength of relationship/controls pairwise covariance

(See (Gelfand, Vounatsou 2003.) for further details)


